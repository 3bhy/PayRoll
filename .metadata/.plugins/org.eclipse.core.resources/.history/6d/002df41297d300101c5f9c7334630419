package com.project.demo.service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import jakarta.annotation.PostConstruct;
import org.hl7.fhir.r4.model.*;
import org.springframework.stereotype.Service;

import java.util.Date;

@Service
public class FhirService {
    private IGenericClient client;
    private final String LOCAL_SERVER = "http://localhost:8080/fhir";
    
    @PostConstruct
    public void initClient() {
        System.out.println("ğŸ¯ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ...");
        System.out.println("ğŸŒ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + LOCAL_SERVER);
        
        try {
            // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ù‚ FHIR Ù„Ù„Ø¥ØµØ¯Ø§Ø± R4
            FhirContext ctx = FhirContext.forR4();
            
            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
            this.client = ctx.newRestfulGenericClient(LOCAL_SERVER);
            
            // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            ctx.getRestfulClientFactory().setConnectTimeout(10000);
            ctx.getRestfulClientFactory().setSocketTimeout(10000);
            
            // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            testConnection();
            
            System.out.println("âœ… âœ… âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR Ø¨Ù†Ø¬Ø§Ø­!");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: " + e.getMessage());
            System.err.println("\nğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø³ÙŠØ±ÙØ± HAPI FHIR:");
            System.err.println("   docker run -p 8080:8080 hapiproject/hapi:v5.7.0");
        }
    }
    
    private void testConnection() {
        try {
            System.out.println("ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ...");
            
            // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
            CapabilityStatement capability = client.capabilities()
                .ofType(CapabilityStatement.class)
                .execute();
            
            System.out.println("âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­!");
            System.out.println("ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±:");
            System.out.println("   - Ø§Ù„Ø¥ØµØ¯Ø§Ø±: " + capability.getFhirVersion().getDisplay());
            System.out.println("   - Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: " + LOCAL_SERVER);
            System.out.println("   - Ø­Ø§Ù„Ø©: Ù†Ø´Ø· âœ…");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ!");
            System.err.println("   Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + e.getMessage());
            throw new RuntimeException("ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø³ÙŠØ±ÙØ± HAPI FHIR Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
        }
    }
    
    public void testSearch() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        System.out.println("\nğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ");
        System.out.println("=".repeat(60));
        
        try {
            // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(10) // 10 Ù†ØªØ§Ø¦Ø¬
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            int total = results.getTotal();
            
            System.out.println("ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:");
            System.out.println("   - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + total);
            System.out.println("   - Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ø¯Ø©: " + count);
            
            if (count > 0) {
                System.out.println("\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:");
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        displayPatientInfo(patient);
                    }
                }
            } else {
                System.out.println("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯.");
                System.out.println("ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… /api/fhir/patient Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¶Ù‰ ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†");
            }
            
        } catch (Exception e) {
            System.err.println("\nâŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
        
        System.out.println("=".repeat(60));
    }
    
    private void displayPatientInfo(Patient patient) {
        StringBuilder info = new StringBuilder("ğŸ‘¤ ");
        
        // Ø§Ù„Ù…Ø¹Ø±Ù
        if (patient.hasId()) {
            String id = patient.getIdElement().getIdPart();
            id = id.substring(id.lastIndexOf("/") + 1);
            info.append("ID: ").append(id).append(" | ");
        }
        
        // Ø§Ù„Ø§Ø³Ù…
        if (patient.hasName() && !patient.getName().isEmpty()) {
            info.append("Ø§Ù„Ø§Ø³Ù…: ");
            
            String givenName = patient.getNameFirstRep().getGivenAsSingleString();
            if (givenName != null && !givenName.isEmpty()) {
                info.append(givenName).append(" ");
            }
            
            String familyName = patient.getNameFirstRep().getFamily();
            if (familyName != null && !familyName.isEmpty()) {
                info.append(familyName);
            }
            
            info.append(" | ");
        }
        
        // Ø§Ù„Ø¬Ù†Ø³
        if (patient.hasGender()) {
            String gender = patient.getGender().getDisplay();
            info.append("Ø§Ù„Ø¬Ù†Ø³: ").append(gender).append(" | ");
        }
        
        // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
        if (patient.hasBirthDate()) {
            Date birthDate = patient.getBirthDate();
            info.append("Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ").append(birthDate);
        }
        
        System.out.println(info.toString());
    }
    
    public void createSamplePatient() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nâ• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ...");
            
            Patient patient = new Patient();
            patient.addName()
                .addGiven("Ø£Ø­Ù…Ø¯")
                .addGiven("Ù…Ø­Ù…Ø¯")
                .setFamily("Ø§Ù„ØªØ¬Ø±Ø¨Ø©");
            patient.setGender(Enumerations.AdministrativeGender.MALE);
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯
            patient.setBirthDateElement(new DateType("1980-01-01"));
            
            // Ø¥Ø¶Ø§ÙØ© Ù‡Ø§ØªÙ
            patient.addTelecom()
                .setSystem(ContactPoint.ContactPointSystem.PHONE)
                .setValue("+201234567890")
                .setUse(ContactPoint.ContactPointUse.HOME);
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù†
            patient.addAddress()
                .addLine("Ø´Ø§Ø±Ø¹ Ø§Ù„Ù†Ù‡Ø¶Ø©")
                .setCity("Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©")
                .setCountry("Ù…ØµØ±");
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
            ca.uhn.fhir.rest.api.MethodOutcome outcome = client.create()
                .resource(patient)
                .execute();
            
            String patientId = outcome.getId().getIdPart();
            System.out.println("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ!");
            System.out.println("ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:");
            System.out.println("   - Ø§Ù„Ù…Ø¹Ø±Ù: " + patientId);
            System.out.println("   - Ø§Ù„Ø§Ø³Ù…: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø©");
            System.out.println("   - Ø§Ù„Ø¬Ù†Ø³: Ø°ÙƒØ±");
            System.out.println("   - ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: 1980-01-01");
            System.out.println("   - Ø§Ù„Ù‡Ø§ØªÙ: +201234567890");
            System.out.println("   - Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø´Ø§Ø±Ø¹ Ø§Ù„Ù†Ù‡Ø¶Ø©ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶: " + e.getMessage());
        }
    }
    
    public void searchWithCriteria(String familyName) {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø§Ø¦Ù„Ø©: " + familyName);
            
            Bundle results = client.search()
                .forResource(Patient.class)
                .where(Patient.FAMILY.matches().value(familyName))
                .count(10)
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            System.out.println("ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ " + count + " Ù…Ø±ÙŠØ¶");
            
            if (count > 0) {
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        System.out.println("   - " + getPatientName(patient));
                    }
                }
            } else {
                System.out.println("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©.");
            }
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
    }
    
    private String getPatientName(Patient patient) {
        if (!patient.hasName() || patient.getName().isEmpty()) {
            return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        }
        
        StringBuilder name = new StringBuilder();
        
        for (org.hl7.fhir.r4.model.StringType given : patient.getNameFirstRep().getGiven()) {
            if (given != null && !given.getValue().isEmpty()) {
                name.append(given.getValue()).append(" ");
            }
        }
        
        String family = patient.getNameFirstRep().getFamily();
        if (family != null && !family.isEmpty()) {
            name.append(family);
        }
        
        return name.toString().trim();
    }
    
    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø© Ù…Ø±Ø¶Ù‰ ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†
    public void createSamplePatients() {
        String[][] patients = {
            {"Ù…Ø­Ù…Ø¯", "Ø¹Ù„ÙŠ", "Ø°ÙƒØ±", "1990-05-15"},
            {"ÙØ§Ø·Ù…Ø©", "Ø­Ø³Ù†", "Ø£Ù†Ø«Ù‰", "1985-08-22"},
            {"Ø®Ø§Ù„Ø¯", "Ø£Ø­Ù…Ø¯", "Ø°ÙƒØ±", "1978-12-10"},
            {"Ø³Ø§Ø±Ø©", "Ù…Ø­Ù…ÙˆØ¯", "Ø£Ù†Ø«Ù‰", "1995-03-20"}
        };
        
        System.out.println("\nâ• Ø¥Ù†Ø´Ø§Ø¡ " + patients.length + " Ù…Ø±Ø¶Ù‰ ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†...");
        
        for (String[] patientData : patients) {
            try {
                Patient patient = new Patient();
                patient.addName()
                    .addGiven(patientData[0])
                    .setFamily(patientData[1]);
                
                if (patientData[2].equals("Ø°ÙƒØ±")) {
                    patient.setGender(Enumerations.AdministrativeGender.MALE);
                } else {
                    patient.setGender(Enumerations.AdministrativeGender.FEMALE);
                }
                
                patient.setBirthDateElement(new DateType(patientData[3]));
                
                // Ø¥Ø¶Ø§ÙØ© Ù‡Ø§ØªÙ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                String phone = "+201" + (int)(Math.random() * 9000000 + 1000000);
                patient.addTelecom()
                    .setSystem(ContactPoint.ContactPointSystem.PHONE)
                    .setValue(phone);
                
                client.create().resource(patient).execute();
                System.out.println("   âœ… " + patientData[0] + " " + patientData[1]);
                
            } catch (Exception e) {
                System.err.println("   âŒ " + patientData[0] + " " + patientData[1] + ": " + e.getMessage());
            }
        }
        
        System.out.println("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ†!");
    }
}