package com.project.demo.service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import jakarta.annotation.PostConstruct;
import org.hl7.fhir.r4.model.Bundle;
import org.hl7.fhir.r4.model.Patient;
import org.springframework.stereotype.Service;

@Service
public class FhirService {
    private IGenericClient client;
    
    @PostConstruct
    public void initClient() {
        System.out.println("ğŸ¯ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR...");
        
        try {
            // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… FhirContext Ù„Ù„Ø¥ØµØ¯Ø§Ø± R4
            FhirContext ctx = FhirContext.forR4();
            
            // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙŠØ±ÙØ± HAPI FHIR Ø§Ù„Ø¹Ø§Ù…
            String serverBase = "http://hapi.fhir.org/baseR4";
            System.out.println("ğŸ“¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            
            // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
            this.client = ctx.newRestfulGenericClient(serverBase);
            
            // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù„Ø§Øª Ù‚ØµÙŠØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            ctx.getRestfulClientFactory().setConnectTimeout(10 * 1000);
            ctx.getRestfulClientFactory().setSocketTimeout(10 * 1000);
            
            System.out.println("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR Ø¨Ù†Ø¬Ø§Ø­!");
            
        } catch (Exception e) {
            System.err.println("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: " + e.getMessage());
        }
    }
    
    public void testSearch() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸ” Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø«...");
            
            // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(2) // ÙÙ‚Ø· Ù†ØªÙŠØ¬ØªÙŠÙ†
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø¨Ø­Ø«! Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: " + count);
            
            if (count > 0) {
                System.out.println("\nğŸ“‹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:");
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        
                        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
                        String id = extractId(patient.getIdElement().getIdPart());
                        
                        // Ø§Ù„Ø§Ø³Ù…
                        String name = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                        if (patient.hasName() && !patient.getName().isEmpty()) {
                            String given = patient.getNameFirstRep().getGivenAsSingleString();
                            String family = patient.getNameFirstRep().getFamily();
                            name = (given != null ? given + " " : "") + (family != null ? family : "");
                        }
                        
                        System.out.println("   - ID: " + id + " | Ø§Ù„Ø§Ø³Ù…: " + name.trim());
                    }
                }
            }
            
        } catch (Exception e) {
            System.err.println("\nâŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø·Ø£ 404ØŒ Ø¬Ø±Ø¨ Ø³ÙŠØ±ÙØ±Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹
            if (e.getMessage().contains("404")) {
                System.out.println("\nğŸ’¡ Ø¬Ø±Ø¨ Ø³ÙŠØ±ÙØ± SmartHealthIT...");
                trySmartHealthIT();
            }
        }
    }
    
    private String extractId(String fullId) {
        if (fullId.contains("/")) {
            return fullId.substring(fullId.lastIndexOf("/") + 1);
        }
        return fullId;
    }
    
    private void trySmartHealthIT() {
        try {
            System.out.println("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø³ÙŠØ±ÙØ± SmartHealthIT...");
            
            FhirContext ctx = FhirContext.forR4();
            String serverBase = "https://r4.smarthealthit.org";
            
            this.client = ctx.newRestfulGenericClient(serverBase);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„! Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: " + results.getEntry().size());
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø¯ÙŠÙ„: " + e.getMessage());
            System.out.println("\nğŸ’¡ Ø§Ù„Ø­Ù„: ØªØ´ØºÙŠÙ„ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ");
            System.out.println("   docker run -p 8080:8080 hapiproject/hapi:v6.3.0");
            System.out.println("   Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù…: http://localhost:8080/fhir");
        }
    }
}