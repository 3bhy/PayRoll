package com.fhir;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import org.hl7.fhir.r4.model.*;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;

@Service
public class FhirService {
    private IGenericClient client;
    private String currentServer = "https://hapi.fhir.org/baseR4"; // Ø³ÙŠØ±ÙØ± Ø¹Ø§Ù…
    
    @PostConstruct
    public void init() {
        System.out.println("ğŸš€ Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø© FHIR Ù…Ø¹ Ø³ÙŠØ±ÙØ±Ø§Øª Ø¹Ø§Ù…Ø©...");
        
        try {
            // Ø¬Ø±Ø¨ Ø¹Ø¯Ø© Ø³ÙŠØ±ÙØ±Ø§Øª
            String[] servers = {
                "https://hapi.fhir.org/baseR4",      // Ø§Ù„Ø£ÙØ¶Ù„
                "https://r4.smarthealthit.org",      // Ø¨Ø¯ÙŠÙ„
                "http://vonk.fire.ly/R4"             // Ø¨Ø¯ÙŠÙ„ Ø¢Ø®Ø±
            };
            
            for (String server : servers) {
                if (connectToServer(server)) {
                    this.currentServer = server;
                    break;
                }
            }
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø©: " + e.getMessage());
        }
    }
    
    private boolean connectToServer(String serverUrl) {
        try {
            System.out.println("ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverUrl);
            
            FhirContext ctx = FhirContext.forR4();
            this.client = ctx.newRestfulGenericClient(serverUrl);
            
            // Ù…Ù‡Ù„Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¹Ø§Ù…
            ctx.getRestfulClientFactory().setConnectTimeout(15000);
            ctx.getRestfulClientFactory().setSocketTimeout(15000);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            CapabilityStatement cs = client.capabilities()
                .ofType(CapabilityStatement.class)
                .execute();
            
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverUrl);
            System.out.println("ğŸ“Š Ø¥ØµØ¯Ø§Ø± FHIR: " + cs.getFhirVersion().getDisplay());
            System.out.println("ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯: " + (cs.hasRest() ? cs.getRestFirstRep().getResource().size() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
            
            return true;
            
        } catch (Exception e) {
            System.err.println("   âŒ ÙØ´Ù„: " + e.getMessage());
            return false;
        }
    }
    
    public String getServerInfo() {
        return """
               <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                   <strong>ğŸŒ Ø§Ù„Ø³ÙŠØ±ÙØ±:</strong> %s
                   <br><strong>ğŸ“Œ Ø§Ù„Ù†ÙˆØ¹:</strong> Ø³ÙŠØ±ÙØ± FHIR Ø¹Ø§Ù…
                   <br><strong>âœ… Ø§Ù„Ù…ÙŠØ²Ø©:</strong> Ù„Ø§ ÙŠØªØ·Ù„Ø¨ Docker
                   <br><a href="%s/metadata" target="_blank" style="color: #1565c0;">ğŸ”— ÙØªØ­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±</a>
               </div>
               """.formatted(currentServer, currentServer);
    }
    
    public String searchPatients() {
        try {
            System.out.println("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¹Ø§Ù…...");
            
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(20)  // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø¯
                .returnBundle(Bundle.class)
                .execute();
            
            int total = results.getTotal();
            int returned = results.getEntry().size();
            
            StringBuilder html = new StringBuilder();
            html.append("""
                       <div style="background: #f1f8e9; padding: 20px; border-radius: 8px; margin: 15px 0;">
                           <h3 style="margin-top: 0;">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
                           <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±:</strong> %d</p>
                           <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ø¯Ø©:</strong> %d</p>
                       </div>
                       """.formatted(total, returned));
            
            if (returned > 0) {
                html.append("""
                           <div style="overflow-x: auto;">
                               <table style="width: 100%%; border-collapse: collapse; margin: 20px 0;">
                                   <thead>
                                       <tr style="background: #4CAF50; color: white;">
                                           <th style="padding: 12px; text-align: left;">#</th>
                                           <th style="padding: 12px; text-align: left;">Ø§Ù„Ù…Ø¹Ø±Ù</th>
                                           <th style="padding: 12px; text-align: left;">Ø§Ù„Ø§Ø³Ù…</th>
                                           <th style="padding: 12px; text-align: left;">Ø§Ù„Ø¬Ù†Ø³</th>
                                           <th style="padding: 12px; text-align: left;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                       </tr>
                                   </thead>
                                   <tbody>
                           """);
                
                int counter = 1;
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        
                        String patientId = extractPatientId(patient.getIdElement().getIdPart());
                        String name = getPatientName(patient);
                        String gender = patient.hasGender() ? 
                            patient.getGender().getDisplay() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                        
                        html.append("""
                                   <tr style="border-bottom: 1px solid #ddd;">
                                       <td style="padding: 10px;">%d</td>
                                       <td style="padding: 10px;">
                                           <code style="background: #eee; padding: 2px 5px; border-radius: 3px;">%s</code>
                                       </td>
                                       <td style="padding: 10px;">%s</td>
                                       <td style="padding: 10px;">%s</td>
                                       <td style="padding: 10px;">
                                           <a href="%s/Patient/%s" target="_blank" 
                                              style="background: #2196F3; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 0.9em;">
                                               ğŸ” Ø¹Ø±Ø¶
                                           </a>
                                       </td>
                                   </tr>
                                   """.formatted(counter, patientId, name, gender, currentServer, patientId));
                        
                        counter++;
                    }
                }
                
                html.append("""
                               </tbody>
                           </table>
                       </div>
                       """);
            } else {
                html.append("""
                           <div style="text-align: center; padding: 40px; color: #666;">
                               <div style="font-size: 3em;">ğŸ“­</div>
                               <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                               <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±</p>
                           </div>
                           """);
            }
            
            return html.toString();
            
        } catch (Exception e) {
            return """
                   <div style="background: #ffebee; padding: 20px; border-radius: 8px; margin: 15px 0;">
                       <h3 style="color: #c62828; margin-top: 0;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</h3>
                       <p><strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong> %s</p>
                       <p style="margin-top: 15px;">
                           <button onclick="location.reload()" 
                                   style="background: #c62828; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                               ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                           </button>
                       </p>
                   </div>
                   """.formatted(e.getMessage());
        }
    }
    
    public String createTestPatient() {
        try {
            System.out.println("â• Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ...");
            
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ø¹Ø¸Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ø±Ø¯
            // Ù„Ø°Ù„Ùƒ Ø³Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
            
            return """
                   <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffeaa7;">
                       <h3 style="color: #856404; margin-top: 0;">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©</h3>
                       <p>Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø«Ù„ <strong>%s</strong> Ù„Ø§ ØªØ³Ù…Ø­ Ø¹Ø§Ø¯Ø©Ù‹ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©.</p>
                       <p>Ù‡Ø°Ø§ Ø¥Ø¬Ø±Ø§Ø¡ Ø£Ù…Ù†ÙŠ Ù„Ù…Ù†Ø¹ Ø¥Ø³Ø§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</p>
                       
                       <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                           <strong>ğŸ’¡ Ù…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡:</strong>
                           <ul style="margin: 10px 0; padding-left: 20px;">
                               <li>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†</li>
                               <li>ğŸ“– Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</li>
                               <li>âš™ï¸ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø­Ù„ÙŠØ©</li>
                           </ul>
                       </div>
                       
                       <div style="margin-top: 15px;">
                           <strong>ğŸ”§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong>
                           <ol style="margin: 10px 0; padding-left: 20px;">
                               <li>Ø§Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ±ÙØ± FHIR Ù…Ø­Ù„ÙŠ (ÙŠØªØ·Ù„Ø¨ Docker)</li>
                               <li>Ø§Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ±ÙØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø®Ø§Øµ</li>
                               <li>Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¦Ø© ØªØ·ÙˆÙŠØ± Ù…Ø­Ù„ÙŠØ©</li>
                           </ol>
                       </div>
                   </div>
                   """.formatted(currentServer);
            
        } catch (Exception e) {
            return "âŒ Ø®Ø·Ø£: " + e.getMessage();
        }
    }
    
    public String getSystemInfo() {
        try {
            CapabilityStatement cs = client.capabilities()
                .ofType(CapabilityStatement.class)
                .execute();
            
            return """
                   <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 15px 0;">
                       <h3 style="margin-top: 0;">ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                       <p><strong>ğŸŒ Ø§Ù„Ø³ÙŠØ±ÙØ±:</strong> %s</p>
                       <p><strong>ğŸ“‹ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> %s</p>
                       <p><strong>ğŸ¢ Ø§Ù„Ù†Ø§Ø´Ø±:</strong> %s</p>
                       <p><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> %s</p>
                       <p><strong>âœ… Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="color: #2e7d32;">â— Ù†Ø´Ø·</span></p>
                   </div>
                   """.formatted(
                       currentServer,
                       cs.getFhirVersion().getDisplay(),
                       cs.hasPublisher() ? cs.getPublisher() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                       cs.hasDate() ? cs.getDateElement().toHumanDisplay() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
                   );
            
        } catch (Exception e) {
            return "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…: " + e.getMessage();
        }
    }
    
    private String extractPatientId(String fullId) {
        if (fullId.contains("/")) {
            return fullId.substring(fullId.lastIndexOf("/") + 1);
        }
        return fullId;
    }
    
    private String getPatientName(Patient patient) {
        if (!patient.hasName() || patient.getName().isEmpty()) {
            return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        }
        
        String given = patient.getNameFirstRep().getGivenAsSingleString();
        String family = patient.getNameFirstRep().getFamily();
        
        return (given != null ? given + " " : "") + (family != null ? family : "");
    }
}