package com.project.demo.service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import jakarta.annotation.PostConstruct;
import org.hl7.fhir.r4.model.Bundle;
import org.hl7.fhir.r4.model.Patient;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class FhirService {
    private IGenericClient client;
    private String currentServer;
    
    @PostConstruct
    public void initClient() {
        System.out.println("ğŸ¯ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR...");
        
        // Ø¬Ø±Ø¨ Ø¹Ø¯Ø© Ø³ÙŠØ±ÙØ±Ø§Øª
        String[] servers = {
            "https://r4.smarthealthit.org",      // Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø§ Ø±Ø£ÙŠÙ†Ø§
            "https://hapi.fhir.org/baseR4",      // Ù…Ø¹ HTTPS
            "http://hapi.fhir.org/baseR4",       // Ø¨Ø¯ÙˆÙ† HTTPS
            "http://vonk.fire.ly/R4"             // Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„
        };
        
        for (String server : servers) {
            if (tryConnect(server)) {
                this.currentServer = server;
                break;
            }
        }
        
        if (client == null) {
            System.err.println("âŒ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø£ÙŠ Ø³ÙŠØ±ÙØ±");
        }
    }
    
    private boolean tryConnect(String serverBase) {
        try {
            System.out.println("ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            
            FhirContext ctx = FhirContext.forR4();
            IGenericClient tempClient = ctx.newRestfulGenericClient(serverBase);
            
            // Ù…Ù‡Ù„Ø§Øª Ù‚ØµÙŠØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            ctx.getRestfulClientFactory().setConnectTimeout(5000);
            ctx.getRestfulClientFactory().setSocketTimeout(5000);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·
            Bundle test = tempClient.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            // Ø¥Ø°Ø§ Ù†Ø¬Ø­ØŒ Ø§Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
            this.client = tempClient;
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            System.out.println("   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†: " + test.getTotal());
            
            return true;
            
        } catch (Exception e) {
            System.err.println("   âŒ ÙØ´Ù„: " + e.getMessage());
            return false;
        }
    }
    
    public void testSearch() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        System.out.println("\nğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ù†: " + currentServer);
        System.out.println("=".repeat(60));
        
        try {
            // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(5) // 5 Ù†ØªØ§Ø¦Ø¬
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            int total = results.getTotal();
            
            System.out.println("ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:");
            System.out.println("   - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + total);
            System.out.println("   - Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ø¯Ø©: " + count);
            
            if (count > 0) {
                System.out.println("\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:");
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        displayPatientInfo(patient);
                    }
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù…Ø«Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                System.out.println("\nğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ù„Ù…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡:");
                System.out.println("1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯");
                System.out.println("2. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙŠØ¶");
                System.out.println("3. Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø©");
                System.out.println("4. Ø¬Ù„Ø¨ Ù…ÙˆØ±Ø¯ Ù…Ø­Ø¯Ø¯");
            }
            
        } catch (Exception e) {
            System.err.println("\nâŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
        
        System.out.println("=".repeat(60));
    }
    
    private void displayPatientInfo(Patient patient) {
        StringBuilder info = new StringBuilder("ğŸ‘¤ ");
        
        // Ø§Ù„Ù…Ø¹Ø±Ù
        if (patient.hasId()) {
            String id = patient.getIdElement().getIdPart();
            id = id.substring(id.lastIndexOf("/") + 1);
            info.append("ID: ").append(id).append(" | ");
        }
        
        // Ø§Ù„Ø§Ø³Ù…
        if (patient.hasName() && !patient.getName().isEmpty()) {
            List<String> givenNames = patient.getNameFirstRep().getGivenAsString();
            String family = patient.getNameFirstRep().getFamily();
            
            info.append("Ø§Ù„Ø§Ø³Ù…: ");
            if (givenNames != null && !givenNames.isEmpty()) {
                info.append(String.join(" ", givenNames)).append(" ");
            }
            if (family != null) {
                info.append(family);
            }
            info.append(" | ");
        }
        
        // Ø§Ù„Ø¬Ù†Ø³
        if (patient.hasGender()) {
            String gender = patient.getGender().getDisplay();
            info.append("Ø§Ù„Ø¬Ù†Ø³: ").append(gender).append(" | ");
        }
        
        // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
        if (patient.hasBirthDate()) {
            info.append("Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ").append(patient.getBirthDate());
        }
        
        System.out.println(info.toString());
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ
    public void createSamplePatient() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nâ• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ...");
            
            Patient patient = new Patient();
            patient.addName()
                .addGiven("Ø£Ø­Ù…Ø¯")
                .setFamily("Ø§Ù„ØªØ¬Ø±Ø¨Ø©");
            patient.setGender(org.hl7.fhir.r4.model.Enumerations.AdministrativeGender.MALE);
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯
            patient.setBirthDateElement(new org.hl7.fhir.r4.model.DateType("1980-01-01"));
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
            ca.uhn.fhir.rest.api.MethodOutcome outcome = client.create()
                .resource(patient)
                .execute();
            
            String patientId = outcome.getId().getIdPart();
            System.out.println("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯!");
            System.out.println("   Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶: " + patientId);
            System.out.println("   Ø§Ù„Ø±Ø§Ø¨Ø·: " + currentServer + "/" + patientId);
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶: " + e.getMessage());
            System.err.println("   Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©");
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¨Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„
    public void searchWithCriteria(String familyName) {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø§Ø¦Ù„Ø©: " + familyName);
            
            Bundle results = client.search()
                .forResource(Patient.class)
                .where(Patient.FAMILY.matches().value(familyName))
                .count(10)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ " + results.getEntry().size() + " Ù…Ø±ÙŠØ¶");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
    }
}