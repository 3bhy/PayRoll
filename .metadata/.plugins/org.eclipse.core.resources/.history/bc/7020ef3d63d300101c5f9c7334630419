package com.project.demo.service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import ca.uhn.fhir.rest.client.interceptor.LoggingInterceptor;
import jakarta.annotation.PostConstruct;
import org.hl7.fhir.r4.model.Bundle;
import org.hl7.fhir.r4.model.Patient;
import org.springframework.stereotype.Service;

@Service
public class FhirService {
    private IGenericClient client;
    private boolean initialized = false;
    
    @PostConstruct
    public void initClient() {
        System.out.println("=== Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© FHIR ===");
        
        try {
            // Ø§Ø³ØªØ®Ø¯Ù… R4 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† R5
            FhirContext ctx = FhirContext.forR4();
            System.out.println("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ù‚ FHIR R4");
            
            // Ø§Ø³ØªØ®Ø¯Ù… HTTPS Ù…Ø¹ HAPI FHIR
            String serverBase = "https://hapi.fhir.org/baseR4";
            System.out.println("ğŸŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
            this.client = ctx.newRestfulGenericClient(serverBase);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            ctx.getRestfulClientFactory().setConnectTimeout(30 * 1000); // 30 Ø«Ø§Ù†ÙŠØ©
            ctx.getRestfulClientFactory().setSocketTimeout(30 * 1000);  // 30 Ø«Ø§Ù†ÙŠØ©
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ­ÙŠØ­
            LoggingInterceptor loggingInterceptor = new LoggingInterceptor();
            loggingInterceptor.setLogger(ca.uhn.fhir.util.VersionLogger.class);
            loggingInterceptor.setLogRequestSummary(true);
            loggingInterceptor.setLogRequestBody(true);
            this.client.registerInterceptor(loggingInterceptor);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            testConnection();
            
            this.initialized = true;
            System.out.println("âœ… âœ… âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR Ø¨Ù†Ø¬Ø§Ø­!");
            System.out.println("=== Ø§Ù†ØªÙ‡Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© FHIR ===");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR: " + e.getMessage());
            e.printStackTrace();
            this.initialized = false;
        }
    }
    
    private void testConnection() {
        try {
            System.out.println("ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...");
            
            // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            Bundle response = client.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­!");
            System.out.println("   Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯: " + response.getType());
            System.out.println("   Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + response.getTotal());
            
        } catch (Exception e) {
            System.err.println("âš ï¸  ØªØ­Ø°ÙŠØ±: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ÙØ´Ù„ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹");
            System.err.println("   Ø§Ù„Ø³Ø¨Ø¨: " + e.getMessage());
            
            // Ø¬Ø±Ø¨ Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„
            tryAlternativeServer();
        }
    }
    
    private void tryAlternativeServer() {
        try {
            System.out.println("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„...");
            
            FhirContext ctx = FhirContext.forR4();
            String alternativeServer = "https://r4.smarthealthit.org";
            
            System.out.println("ğŸŒ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + alternativeServer);
            this.client = ctx.newRestfulGenericClient(alternativeServer);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·
            Bundle test = client.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø¯ÙŠÙ„!");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„");
        }
    }
    
    public void searchPatients() {
        if (!initialized || client == null) {
            System.err.println("âŒ âŒ âŒ ØªØ­Ø°ÙŠØ±: Ø¹Ù…ÙŠÙ„ FHIR ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            System.err.println("   - initialized: " + initialized);
            System.err.println("   - client: " + (client == null ? "NULL" : "Ù…ÙˆØ¬ÙˆØ¯"));
            
            // Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            System.out.println("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");
            initClient();
            
            if (!initialized || client == null) {
                System.err.println("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ±");
                return;
            }
        }
        
        try {
            System.out.println("\n" + "=".repeat(60));
            System.out.println("ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰...");
            System.out.println("=".repeat(60));
            
            // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· ÙˆØ¢Ù…Ù†
            Bundle searchResults = client
                .search()
                .forResource(Patient.class)
                .count(5)  // Ø¹Ø¯Ø¯ Ù‚Ù„ÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
                .returnBundle(Bundle.class)
                .execute();
            
            int patientCount = searchResults.getEntry().size();
            System.out.println("ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:");
            System.out.println("   - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + searchResults.getTotal());
            System.out.println("   - Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ø¯Ø©: " + patientCount);
            
            if (patientCount > 0) {
                System.out.println("\nğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰:");
                for (Bundle.BundleEntryComponent entry : searchResults.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        printPatientDetails(patient);
                    }
                }
            } else {
                System.out.println("âš ï¸  Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±Ø¶Ù‰. Ø¬Ø±Ø¨ Ø¨Ø­Ø«Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙˆØ·...");
                searchAllPatients();
            }
            
            System.out.println("=".repeat(60));
            System.out.println("âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù†Ø¬Ø§Ø­!");
            
        } catch (Exception e) {
            System.err.println("\nâŒ âŒ âŒ Ø®Ø·Ø£ Ø¬Ø³ÙŠÙ… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«!");
            System.err.println("   Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + e.getMessage());
            System.err.println("\nğŸ”§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­:");
            e.printStackTrace();
            
            System.out.println("\nğŸ’¡ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:");
            System.out.println("1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            System.out.println("2. Ø¬Ø±Ø¨ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹");
            System.out.println("3. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø¶Ø¨ÙˆØ·Ø© ÙÙŠ pom.xml");
            System.out.println("4. Ø¬Ø±Ø¨ Ø¥ØµØ¯Ø§Ø±Ø§Ù‹ Ø£Ù‚Ø¯Ù… Ù…Ù† HAPI FHIR (5.7.0)");
        }
    }
    
    private void searchAllPatients() {
        try {
            System.out.println("\nğŸŒ Ø¨Ø­Ø« Ø´Ø§Ù…Ù„...");
            
            Bundle results = client
                .search()
                .forResource(Patient.class)
                .count(3)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰: " + results.getEntry().size());
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„: " + e.getMessage());
        }
    }
    
    private void printPatientDetails(Patient patient) {
        StringBuilder sb = new StringBuilder("   ğŸ‘¤ ");
        
        // Ø§Ù„Ù…Ø¹Ø±Ù
        if (patient.hasId()) {
            String id = patient.getIdElement().getIdPart();
            if (id.contains("/")) {
                id = id.substring(id.lastIndexOf("/") + 1);
            }
            sb.append("ID: ").append(id).append(" | ");
        }
        
        // Ø§Ù„Ø§Ø³Ù…
        if (patient.hasName() && !patient.getName().isEmpty()) {
            String given = patient.getNameFirstRep().getGivenAsSingleString();
            String family = patient.getNameFirstRep().getFamily();
            
            sb.append("Ø§Ù„Ø§Ø³Ù…: ");
            if (given != null && !given.isEmpty()) {
                sb.append(given).append(" ");
            }
            if (family != null && !family.isEmpty()) {
                sb.append(family);
            }
            sb.append(" | ");
        }
        
        // Ø§Ù„Ø¬Ù†Ø³
        if (patient.hasGender()) {
            sb.append("Ø§Ù„Ø¬Ù†Ø³: ").append(patient.getGender().getDisplay());
        }
        
        System.out.println(sb.toString());
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø©
    public String getServiceStatus() {
        if (!initialized) {
            return "âŒ Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ¦Ø©";
        }
        if (client == null) {
            return "âŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        }
        return "âœ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…";
    }
}