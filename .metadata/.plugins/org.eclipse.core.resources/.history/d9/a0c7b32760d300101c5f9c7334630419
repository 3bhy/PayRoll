package com.project.demo.service;

import org.hl7.fhir.r5.model.Bundle;
import org.hl7.fhir.r5.model.CapabilityStatement;
import org.hl7.fhir.r5.model.Enumerations.AdministrativeGender;
import org.hl7.fhir.r5.model.Patient;
import org.springframework.stereotype.Service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.api.MethodOutcome;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import ca.uhn.fhir.rest.gclient.StringClientParam;
import jakarta.annotation.PostConstruct;
@Service
public class FhirService {
    private IGenericClient client;
    
    @PostConstruct
    public void initClient() {
        try {
            FhirContext ctx = FhirContext.forR5();
            
            // Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙŠØ±ÙØ± R4 (Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ù‹Ø§)
            String serverBase = "http://hapi.fhir.org/baseR4";
            
            // Ø£Ùˆ Ø¬Ø±Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø¯ÙŠÙ„
            // String serverBase = "https://hapi.fhir.org/baseR4";
            
            this.client = ctx.newRestfulGenericClient(serverBase);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            ctx.getRestfulClientFactory().setConnectTimeout(5000);
            ctx.getRestfulClientFactory().setSocketTimeout(5000);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            testConnection();
            
        } catch (Exception e) {
            System.err.println("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: " + e.getMessage());
        }
    }
    
    private void testConnection() {
        try {
            // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            System.out.println("Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø³ÙŠØ±ÙØ± FHIR...");
            
            // 1. Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¬Ù„Ø¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ø£Ø¨Ø³Ø·)
            Bundle capabilities = client
                .capabilities()
                .ofType(CapabilityStatement.class)
                .execute();
            
            if (capabilities != null) {
                System.out.println("âœ“ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø³ÙŠØ±ÙØ± FHIR");
                System.out.println("Ø¥ØµØ¯Ø§Ø± FHIR: " + 
                    ((CapabilityStatement)capabilities).getFhirVersion().getDisplay());
            }
            
        } catch (Exception e) {
            System.err.println("âœ— ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„: " + e.getMessage());
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©
            tryAlternativeServer();
        }
    }
    
    private void tryAlternativeServer() {
        try {
            System.out.println("Ø¬Ø±Ø¨ Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„...");
            
            FhirContext ctx = FhirContext.forR4();
            String alternativeServer = "https://r4.smarthealthit.org";
            
            this.client = ctx.newRestfulGenericClient(alternativeServer);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·
            Bundle testResult = client.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("âœ“ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
            
        } catch (Exception ex) {
            System.err.println("âœ— ÙØ´Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„: " + ex.getMessage());
        }
    }
    
    public void searchPatients() {
        try {
            System.out.println("Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰...");
            
            // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø¹Ø§Ø¦Ù„Ø© Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§ Ù„Ù„Ø¨Ø­Ø«
            Bundle searchResults = client
                .search()
                .forResource(Patient.class)
                .where(Patient.FAMILY.contains().value("Smith")) // Ø§Ø³ØªØ®Ø¯Ù… Smith Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Doe
                .count(5) // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                .returnBundle(Bundle.class)
                .execute();
            
            int patientCount = searchResults.getEntry().size();
            System.out.println("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†: " + patientCount);
            
            if (patientCount > 0) {
                System.out.println("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:");
                for (Bundle.BundleEntryComponent entry : searchResults.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        
                        String patientId = patient.getIdElement().getIdPart();
                        String givenName = patient.getNameFirstRep().getGivenAsSingleString();
                        String familyName = patient.getNameFirstRep().getFamily();
                        
                        System.out.println("ğŸ”¹ ID: " + patientId + 
                                         " | Ø§Ù„Ø§Ø³Ù…: " + givenName + " " + familyName);
                    }
                }
            } else {
                System.out.println("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±Ø¶Ù‰ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…. Ø¬Ø±Ø¨ Ø¨Ø­Ø«Ù‹Ø§ Ø¢Ø®Ø±:");
                
                // Ø¨Ø­Ø« Ø¨Ø¯ÙŠÙ„
                searchAlternative();
            }
            
        } catch (Exception e) {
            System.err.println("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void searchAlternative() {
        try {
            // Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø£ÙˆØ³Ø¹
            Bundle results = client
                .search()
                .forResource(Patient.class)
                .count(3)
                .returnBundle(Bundle.class)
                .execute();
            
            System.out.println("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ " + results.getEntry().size() + " Ù…Ø±ÙŠØ¶ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…");
            
        } catch (Exception e) {
            System.err.println("ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¨Ø¯ÙŠÙ„: " + e.getMessage());
        }
    }
}