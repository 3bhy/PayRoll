package com.project.demo.service;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import jakarta.annotation.PostConstruct;
import org.hl7.fhir.r4.model.Bundle;
import org.hl7.fhir.r4.model.Patient;
import org.springframework.stereotype.Service;

import java.util.Date;

@Service
public class FhirService {
    private IGenericClient client;
    private String currentServer;
    
    @PostConstruct
    public void initClient() {
        System.out.println("ğŸ¯ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ FHIR...");
        
        // Ø¬Ø±Ø¨ Ø¹Ø¯Ø© Ø³ÙŠØ±ÙØ±Ø§Øª
        String[] servers = {
            "https://r4.smarthealthit.org",      // Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ ÙƒÙ…Ø§ Ø±Ø£ÙŠÙ†Ø§
            "https://hapi.fhir.org/baseR4",      // Ù…Ø¹ HTTPS
            "http://hapi.fhir.org/baseR4",       // Ø¨Ø¯ÙˆÙ† HTTPS
            "http://vonk.fire.ly/R4"             // Ø³ÙŠØ±ÙØ± Ø¨Ø¯ÙŠÙ„
        };
        
        for (String server : servers) {
            if (tryConnect(server)) {
                this.currentServer = server;
                break;
            }
        }
        
        if (client == null) {
            System.err.println("âŒ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø£ÙŠ Ø³ÙŠØ±ÙØ±");
        }
    }
    
    private boolean tryConnect(String serverBase) {
        try {
            System.out.println("ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            
            FhirContext ctx = FhirContext.forR4();
            IGenericClient tempClient = ctx.newRestfulGenericClient(serverBase);
            
            // Ù…Ù‡Ù„Ø§Øª Ù‚ØµÙŠØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            ctx.getRestfulClientFactory().setConnectTimeout(5000);
            ctx.getRestfulClientFactory().setSocketTimeout(5000);
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³ÙŠØ·
            Bundle test = tempClient.search()
                .forResource(Patient.class)
                .count(1)
                .returnBundle(Bundle.class)
                .execute();
            
            // Ø¥Ø°Ø§ Ù†Ø¬Ø­ØŒ Ø§Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
            this.client = tempClient;
            System.out.println("âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: " + serverBase);
            System.out.println("   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†: " + test.getTotal());
            
            return true;
            
        } catch (Exception e) {
            System.err.println("   âŒ ÙØ´Ù„: " + e.getMessage());
            return false;
        }
    }
    
    public void testSearch() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        System.out.println("\nğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ù†: " + currentServer);
        System.out.println("=".repeat(60));
        
        try {
            // Ø¨Ø­Ø« Ø¨Ø³ÙŠØ·
            Bundle results = client.search()
                .forResource(Patient.class)
                .count(5) // 5 Ù†ØªØ§Ø¦Ø¬
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            int total = results.getTotal();
            
            System.out.println("ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:");
            System.out.println("   - Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + total);
            System.out.println("   - Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø§Ø¯Ø©: " + count);
            
            if (count > 0) {
                System.out.println("\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:");
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        displayPatientInfo(patient);
                    }
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù…Ø«Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                System.out.println("\nğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ù„Ù…Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡:");
                System.out.println("1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯");
                System.out.println("2. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙŠØ¶");
                System.out.println("3. Ø§Ù„Ø¨Ø­Ø« Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø©");
                System.out.println("4. Ø¬Ù„Ø¨ Ù…ÙˆØ±Ø¯ Ù…Ø­Ø¯Ø¯");
            }
            
        } catch (Exception e) {
            System.err.println("\nâŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
        
        System.out.println("=".repeat(60));
    }
    
    private void displayPatientInfo(Patient patient) {
        StringBuilder info = new StringBuilder("ğŸ‘¤ ");
        
        // Ø§Ù„Ù…Ø¹Ø±Ù
        if (patient.hasId()) {
            String id = patient.getIdElement().getIdPart();
            id = id.substring(id.lastIndexOf("/") + 1);
            info.append("ID: ").append(id).append(" | ");
        }
        
        // Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        if (patient.hasName() && !patient.getName().isEmpty()) {
            info.append("Ø§Ù„Ø§Ø³Ù…: ");
            
            // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ø³ØªØ®Ø¯Ø§Ù… getGivenAsSingleString()
            String givenName = patient.getNameFirstRep().getGivenAsSingleString();
            if (givenName != null && !givenName.isEmpty()) {
                info.append(givenName).append(" ");
            }
            
            // Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
            String familyName = patient.getNameFirstRep().getFamily();
            if (familyName != null && !familyName.isEmpty()) {
                info.append(familyName);
            }
            
            info.append(" | ");
        }
        
        // Ø§Ù„Ø¬Ù†Ø³
        if (patient.hasGender()) {
            String gender = patient.getGender().getDisplay();
            info.append("Ø§Ù„Ø¬Ù†Ø³: ").append(gender).append(" | ");
        }
        
        // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
        if (patient.hasBirthDate()) {
            Date birthDate = patient.getBirthDate();
            info.append("Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ").append(birthDate);
        }
        
        System.out.println(info.toString());
    }
    
    // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù…
    private String getPatientName(Patient patient) {
        if (!patient.hasName() || patient.getName().isEmpty()) {
            return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        }
        
        StringBuilder name = new StringBuilder();
        
        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„Ù‰
        for (org.hl7.fhir.r4.model.StringType given : patient.getNameFirstRep().getGiven()) {
            if (given != null && !given.getValue().isEmpty()) {
                name.append(given.getValue()).append(" ");
            }
        }
        
        // Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
        String family = patient.getNameFirstRep().getFamily();
        if (family != null && !family.isEmpty()) {
            name.append(family);
        }
        
        return name.toString().trim();
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ
    public void createSamplePatient() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nâ• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ ØªØ¬Ø±ÙŠØ¨ÙŠ...");
            
            Patient patient = new Patient();
            patient.addName()
                .addGiven("Ø£Ø­Ù…Ø¯")
                .addGiven("Ù…Ø­Ù…Ø¯")  // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… Ø£ÙˆÙ„
                .setFamily("Ø§Ù„ØªØ¬Ø±Ø¨Ø©");
            patient.setGender(org.hl7.fhir.r4.model.Enumerations.AdministrativeGender.MALE);
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯
            patient.setBirthDateElement(new org.hl7.fhir.r4.model.DateType("1980-01-01"));
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            patient.setId(org.hl7.fhir.r4.model.IdType.newRandomUuid());
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
            ca.uhn.fhir.rest.api.MethodOutcome outcome = client.create()
                .resource(patient)
                .execute();
            
            String patientId = outcome.getId().getIdPart();
            System.out.println("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯!");
            System.out.println("   Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶: " + patientId);
            System.out.println("   Ø§Ù„Ø±Ø§Ø¨Ø·: " + currentServer + "/" + patientId);
            
            // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ù†Ø´Ø£
            System.out.println("   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:");
            System.out.println("     - Ø§Ù„Ø§Ø³Ù…: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø©");
            System.out.println("     - Ø§Ù„Ø¬Ù†Ø³: Ø°ÙƒØ±");
            System.out.println("     - ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: 1980-01-01");
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠØ¶: " + e.getMessage());
            System.err.println("   Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©");
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¨Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„
    public void searchWithCriteria(String familyName) {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø§Ø¦Ù„Ø©: " + familyName);
            
            Bundle results = client.search()
                .forResource(Patient.class)
                .where(Patient.FAMILY.matches().value(familyName))
                .count(10)
                .returnBundle(Bundle.class)
                .execute();
            
            int count = results.getEntry().size();
            System.out.println("ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ " + count + " Ù…Ø±ÙŠØ¶");
            
            if (count > 0) {
                for (Bundle.BundleEntryComponent entry : results.getEntry()) {
                    if (entry.getResource() instanceof Patient) {
                        Patient patient = (Patient) entry.getResource();
                        System.out.println("   - " + getPatientName(patient));
                    }
                }
            }
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«: " + e.getMessage());
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ù…Ø±ÙŠØ¶ Ù…Ø­Ø¯Ø¯
    public void getPatientById(String patientId) {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸ“„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶: " + patientId);
            
            Patient patient = client.read()
                .resource(Patient.class)
                .withId(patientId)
                .execute();
            
            System.out.println("âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:");
            System.out.println("   Ø§Ù„Ø§Ø³Ù…: " + getPatientName(patient));
            System.out.println("   Ø§Ù„Ø¬Ù†Ø³: " + 
                (patient.hasGender() ? patient.getGender().getDisplay() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
            System.out.println("   Ø§Ù„Ù…Ø¹Ø±Ù: " + patient.getIdElement().getIdPart());
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ÙŠØ¶: " + e.getMessage());
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
    public void displayServerInfo() {
        if (client == null) {
            System.err.println("âš ï¸  Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ù‡ÙŠØ¦!");
            return;
        }
        
        try {
            System.out.println("\nğŸŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±:");
            System.out.println("   Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: " + currentServer);
            
            // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
            var capabilityStatement = client.capabilities()
                .ofType(org.hl7.fhir.r4.model.CapabilityStatement.class)
                .execute();
            
            if (capabilityStatement != null) {
                System.out.println("   Ø§Ù„Ø¥ØµØ¯Ø§Ø±: " + capabilityStatement.getFhirVersion().getDisplay());
                System.out.println("   Ø§Ù„Ù†Ø§Ø´Ø±: " + 
                    (capabilityStatement.hasPublisher() ? capabilityStatement.getPublisher() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
            }
            
        } catch (Exception e) {
            System.err.println("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±: " + e.getMessage());
        }
    }
}