package com.example.demo.controller;

import com.example.demo.entity.Patient;
import com.example.demo.repo.PatientRepo;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/fhir")
public class PatientController {
    
    private final PatientRepo patientRepository;
    private final ObjectMapper objectMapper = new ObjectMapper();
    
    public PatientController(PatientRepo patientRepository) {
        this.patientRepository = patientRepository;
    }
    
    @PostMapping("/Patient")
    public Map<String, Object> createPatient(@RequestBody String jsonBody) {
        try {
            System.out.println("\nğŸ“¥ " + "=".repeat(40));
            System.out.println("ğŸ“‹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Patient Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§ÙŠÙ†Øª...");
            System.out.println("=".repeat(40));
            
            // ØªØ­Ù„ÙŠÙ„ JSON
            JsonNode jsonNode = objectMapper.readTree(jsonBody);
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            String familyName = "";
            String givenName = "";
            String gender = "";
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…
            if (jsonNode.has("name") && jsonNode.get("name").isArray() && 
                jsonNode.get("name").size() > 0) {
                JsonNode nameNode = jsonNode.get("name").get(0);
                
                if (nameNode.has("family")) {
                    familyName = nameNode.get("family").asText();
                }
                
                if (nameNode.has("given") && nameNode.get("given").isArray() && 
                    nameNode.get("given").size() > 0) {
                    givenName = nameNode.get("given").get(0).asText();
                }
            }
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ÙˆØ¹
            if (jsonNode.has("gender")) {
                gender = jsonNode.get("gender").asText();
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            System.out.println("ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:");
            System.out.println("   - Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©: " + familyName);
            System.out.println("   - Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: " + givenName);
            
            // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            Patient patient = new Patient();
            patient.setFamilyName(familyName);
            patient.setFirstName(givenName);
            patient.setGender(gender);
           
            
            Patient savedPatient = patientRepository.save(patient);
            
            System.out.println("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
            System.out.println("   - ID ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + savedPatient.getId());
            System.out.println("=".repeat(40) + "\n");
            
            // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙƒÙ„Ø§ÙŠÙ†Øª
            
        } catch (Exception e) {
            System.err.println("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Patient: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }}
    